<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live AIS Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .status {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.92);
      padding: 10px 12px;
      border-radius: 10px;
      font-family: system-ui, Arial, sans-serif;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      line-height: 1.25;
      max-width: 70vw;
    }
    .status .small { font-size: 12px; opacity: 0.8; }
  </style>
</head>

<body>
  <div class="status" id="status">
    Loadingâ€¦
    <div class="small" id="status2"></div>
  </div>
  <div id="map"></div>

  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>

    // Centre on UK
    const map = L.map('map').setView([54.5, -3.0], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);
    
    const markers = new Map();
    const REFRESH_MS = 10_000;

    // Remove markers if json not found
    function removeMissing(seenSet) {
      for (const [mmsi, marker] of markers.entries()) {
        if (!seenSet.has(mmsi)) {
          map.removeLayer(marker);
          markers.delete(mmsi);
        }
      }
    }

    async function refresh() {
      const status = document.getElementById('status');
      const status2 = document.getElementById('status2');
      const seen = new Set();

      try {
        
        const url = `vessels.json?t=${Date.now()}`;
        const res = await fetch(url, { cache: "no-store" });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const vessels = await res.json(); 

        // Update status
        status.textContent = `Vessels shown: ${vessels.length}`;
        status2.textContent = `Last refresh: ${new Date().toLocaleTimeString()}`;

        for (const v of vessels) {
          const mmsi = String(v.mmsi);
          const lat = Number(v.lat);
          const lon = Number(v.lon);

          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

          seen.add(mmsi);

          const popupHtml =
            `<b>MMSI:</b> ${mmsi}<br>` +
            (v.last_seen ? `<b>last_seen:</b> ${v.last_seen}<br>` : "") +
            (v.last_seen_utc ? `<b>last_seen_utc:</b> ${v.last_seen_utc}<br>` : "");

          if (markers.has(mmsi)) {
            markers.get(mmsi).setLatLng([lat, lon]).setPopupContent(popupHtml);
          } else {
            const marker = L.circleMarker([lat, lon], {
              radius: 1
            }).addTo(map).bindPopup(popupHtml);
            markers.set(mmsi, marker);
          }
        }

        removeMissing(seen);
      } catch (err) {
        status.textContent = `Error loading vessels.json`;
        status2.textContent = String(err);
      }
    }

    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
